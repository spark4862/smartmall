ğŸ”„ åœºæ™¯å¯¹æ¯”ï¼šæ²¡æœ‰OTel vs æœ‰OTel
1ï¸âƒ£ æ²¡æœ‰OTelçš„ç—›ç‚¹
å‡è®¾ä½ çš„åº”ç”¨ç›´æ¥å¯¹æ¥å„ä¸ªåç«¯ï¼š

python
# æ—¥å¿—ï¼šç›´æ¥è°ƒç”¨Lokiçš„SDK
from loki_sdk import LokiClient
loki = LokiClient(url="http://loki:3100")
loki.push_log("User [Alice] logged in")

# æŒ‡æ ‡ï¼šç›´æ¥è°ƒç”¨Prometheusçš„SDK
from prometheus_client import Counter
login_counter = Counter("login_requests_total", "Login requests")
login_counter.inc()

# è¿½è¸ªï¼šç›´æ¥è°ƒç”¨Jaegerçš„SDK
from jaeger_client import Tracer
tracer = Tracer(...)
with tracer.start_span("login_process"):
    ...
é—®é¢˜ï¼š

ä»£ç è‡ƒè‚¿ï¼šéœ€è¦é›†æˆå¤šä¸ªä¸åŒSDKï¼ˆLoki/Prometheus/Jaegerï¼‰ã€‚

è€¦åˆæ€§é«˜ï¼šæ›´æ¢å­˜å‚¨ç³»ç»Ÿï¼ˆå¦‚ESæ›¿æ¢Lokiï¼‰éœ€ä¿®æ”¹ä»£ç ã€‚

æ ¼å¼æ··ä¹±ï¼šä¸åŒSDKç”Ÿæˆçš„æ•°æ®æ ¼å¼ä¸ç»Ÿä¸€ï¼ŒåæœŸå¤„ç†å›°éš¾ã€‚

2ï¸âƒ£ æœ‰OTelçš„ä¼˜åŠ¿
OTelé€šè¿‡ç»Ÿä¸€SDKå’Œæ ‡å‡†åŒ–åè®®è§£å†³ä¸Šè¿°é—®é¢˜ï¼š

python
# ç»Ÿä¸€ä½¿ç”¨OTel SDKç”Ÿæˆæ•°æ®
from opentelemetry import logs, metrics, trace

# æ—¥å¿—
logger = logs.get_logger("app")
logger.emit("User [Alice] logged in")

# æŒ‡æ ‡
meter = metrics.get_meter("app")
login_counter = meter.create_counter("login_requests_total")
login_counter.add(1, {"status": "200"})

# è¿½è¸ª
tracer = trace.get_tracer("app")
with tracer.start_as_current_span("login_process"):
    ...
ä¼˜åŠ¿ï¼š

ä»£ç ç®€æ´ï¼šåªéœ€é›†æˆOTelä¸€ä¸ªSDKã€‚

æ•°æ®æ ‡å‡†åŒ–ï¼šæ‰€æœ‰æ•°æ®ï¼ˆLogs/Metrics/Tracesï¼‰é€šè¿‡OTelåè®®ï¼ˆå¦‚OTLPï¼‰è¾“å‡ºã€‚

çµæ´»è·¯ç”±ï¼šé€šè¿‡OTel CollectoråŠ¨æ€é…ç½®æ•°æ®è½¬å‘åˆ°Loki/Prometheus/Jaegerï¼Œæ— éœ€ä¿®æ”¹ä»£ç ã€‚

ğŸ› ï¸ OTelçš„æ ¸å¿ƒä½œç”¨
1ï¸âƒ£ æ ‡å‡†åŒ–æ•°æ®ç”Ÿæˆ
ç»Ÿä¸€æ ¼å¼ï¼šæ‰€æœ‰å¯è§‚æµ‹æ•°æ®ï¼ˆLogs/Metrics/Tracesï¼‰é€šè¿‡OTelåè®®ï¼ˆå¦‚OTLPï¼‰è¾“å‡ºã€‚

è·¨è¯­è¨€æ”¯æŒï¼šJava/Python/Goç­‰åº”ç”¨ä½¿ç”¨ç›¸åŒçš„APIç”Ÿæˆæ•°æ®ã€‚

è¯­ä¹‰çº¦å®šï¼šå®šä¹‰æ ‡å‡†çš„å±æ€§ï¼ˆå¦‚http.status_codeã€service.nameï¼‰ï¼Œé¿å…ä¸åŒå›¢é˜Ÿæ•°æ®æ ¼å¼æ··ä¹±ã€‚

2ï¸âƒ£ è§£è€¦æ•°æ®é‡‡é›†
å±è”½åç«¯å·®å¼‚ï¼šåº”ç”¨æ— éœ€å…³å¿ƒæ•°æ®æœ€ç»ˆå­˜å‚¨åœ¨å“ªé‡Œï¼ˆLoki/ES/Prometheus/Jaegerï¼‰ã€‚

åŠ¨æ€è·¯ç”±ï¼šé€šè¿‡ä¿®æ”¹OTel Collectoré…ç½®ï¼Œå³å¯åˆ‡æ¢å­˜å‚¨ç³»ç»Ÿï¼ˆä¾‹å¦‚ä»Lokiè¿ç§»åˆ°ESï¼‰ã€‚

æ•°æ®é¢„å¤„ç†ï¼šåœ¨Collectorä¸­å®Œæˆæ•°æ®è¿‡æ»¤ã€é‡‡æ ·ã€å¯ŒåŒ–ç­‰æ“ä½œï¼ˆä¾‹å¦‚åˆ é™¤æ•æ„Ÿä¿¡æ¯ï¼‰ã€‚

ğŸŒ° ä¸¾ä¸ªå…·ä½“ä¾‹å­
åœºæ™¯ï¼šå°†æ—¥å¿—ä»Lokiè¿ç§»åˆ°Elasticsearch
æ²¡æœ‰OTelï¼š
éœ€ä¿®æ”¹åº”ç”¨ä»£ç ï¼Œæ›¿æ¢Loki SDKä¸ºES SDKï¼Œé‡æ–°éƒ¨ç½²åº”ç”¨ã€‚
âŒ é£é™©é«˜ï¼šä»£ç å˜æ›´å¯èƒ½å¼•å…¥Bugï¼Œä¸”éœ€åœæœºå‘å¸ƒã€‚

æœ‰OTelï¼š
åªéœ€ä¿®æ”¹OTel Collectoré…ç½®ï¼Œå°†æ—¥å¿—å¯¼å‡ºç›®æ ‡ä»Lokiæ”¹ä¸ºESã€‚

yaml
exporters:
  # æ—§é…ç½®ï¼ˆLokiï¼‰
  # loki: 
  #   endpoint: "http://loki:3100"
  
  # æ–°é…ç½®ï¼ˆESï¼‰
  elasticsearch:
    endpoints: ["http://es:9200"]
âœ… é›¶ä»£ç å˜æ›´ï¼šåº”ç”¨æ— æ„ŸçŸ¥ï¼Œæ•°æ®æ— ç¼åˆ‡æ¢ã€‚

ğŸ“Š OTel Collectorçš„æ ¸å¿ƒèƒ½åŠ›
OTel Collectorä¸ä»…æ˜¯â€œæ•°æ®è½¬å‘å™¨â€ï¼Œæ›´æ˜¯â€œæ•°æ®å¤„ç†ç®¡é“â€ï¼š

åŠŸèƒ½	ç¤ºä¾‹åœºæ™¯
åè®®è½¬æ¢	å°†OTLPåè®®æ•°æ®è½¬æ¢ä¸ºLoki/Prometheusæ”¯æŒçš„æ ¼å¼
æ•°æ®è¿‡æ»¤	ä¸¢å¼ƒè°ƒè¯•æ—¥å¿—æˆ–ä½ä¼˜å…ˆçº§æŒ‡æ ‡
é‡‡æ ·	ä»…ä¿ç•™1%çš„è¿½è¸ªæ•°æ®ä»¥é™ä½å­˜å‚¨æˆæœ¬
å¯ŒåŒ–å…ƒæ•°æ®	ä¸ºæ‰€æœ‰æ—¥å¿—æ·»åŠ service.name=user-service
è´Ÿè½½å‡è¡¡	å°†æ•°æ®åˆ†å‘ç»™å¤šä¸ªPrometheuså®ä¾‹
ğŸ—ºï¸ ä¿®æ­£åçš„ç»„ä»¶å…³ç³»å›¾
+----------------+     +---------------------+     +-----------------+     +-----------------+
|                |     |                     |     |                 |     |                 |
|   Application  +---->| OpenTelemetry SDK   +---->| OTel Collector  +---->| Loki/ES         |
|   (ç”Ÿæˆæ•°æ®)    |     | (ç»Ÿä¸€ç”Ÿæˆæ ‡å‡†æ•°æ®)    |     | (æ•°æ®è·¯ç”±/å¤„ç†)   |     | Prometheus       |
+----------------+     +----------+----------+     +--------+--------+     | Jaeger          |
                                  |                        |              +-----------------+
                                  |                        |
+----------------+                |                        |
|                |                |                        |
|   Grafana      <----------------+------------------------+
|   (å¯è§†åŒ–)      |                
+----------------+                
å…³é”®å˜åŒ–ï¼š

åº”ç”¨ä¸å†ç›´æ¥å¯¹æ¥Loki/Prometheus/Jaegerï¼Œè€Œæ˜¯ç»Ÿä¸€é€šè¿‡OTel SDKè¾“å‡ºæ•°æ®ã€‚

OTel Collectoræˆä¸ºæ•°æ®æµè½¬çš„æ ¸å¿ƒæ¢çº½ï¼Œè´Ÿè´£åè®®è½¬æ¢å’Œæ•°æ®è·¯ç”±ã€‚

ğŸ“Œ æ€»ç»“ï¼šOTelçš„ä¸å¯æ›¿ä»£æ€§
å¯¹å¼€å‘äººå‘˜ï¼šåªéœ€å…³å¿ƒâ€œç”Ÿæˆæ•°æ®â€ï¼Œæ— éœ€ç»‘å®šå…·ä½“å­˜å‚¨ç³»ç»Ÿã€‚

å¯¹è¿ç»´äººå‘˜ï¼šé€šè¿‡Collectorç»Ÿä¸€ç®¡æ§æ•°æ®æµï¼Œçµæ´»åº”å¯¹æ¶æ„å˜åŒ–ã€‚

å¯¹ç³»ç»Ÿæ¶æ„ï¼šæ ‡å‡†åŒ–å¯è§‚æµ‹æ•°æ®ï¼Œä¸ºåç»­çš„ç›‘æ§ã€å‘Šè­¦ã€æ’éšœæä¾›ä¸€è‡´çš„æ•°æ®åŸºç¡€ã€‚

ä¸€å¥è¯ç†è§£OTelï¼š
å®ƒæ˜¯å¯è§‚æµ‹é¢†åŸŸçš„â€œæ™®é€šè¯â€â€”â€”ç»Ÿä¸€äº†æ•°æ®ç”Ÿæˆå’Œä¼ è¾“çš„æ ‡å‡†ï¼Œè®©åº”ç”¨ã€å­˜å‚¨ã€åˆ†æå·¥å…·ä¹‹é—´æ— éœ€â€œç¿»è¯‘â€å³å¯åä½œã€‚


otelè§£è€¦äº†å‰ç«¯ å’Œåç«¯
åŸæ¥ç”¨äº†åç«¯å°±å¾—ç”¨å¯¹åº”çš„å‰ç«¯ï¼Œç°åœ¨å‰ç«¯åªéœ€è¦æä¾›æ¥å£ï¼Œä¸åŒåç«¯è°ƒç”¨æ¥å£å³å¯
jaeger prometheus æ˜¯åç«¯ + æ•°æ®åˆ†æ
loki æ˜¯logåˆ†æå·¥å…·
grafanaæ˜¯å¯è§†åŒ–å·¥å…·

â€œæœ‰çº¿åè®®â€ï¼ˆWire Protocolï¼‰åœ¨å¯è§‚æµ‹æ€§é¢†åŸŸï¼ŒæŒ‡çš„æ˜¯åœ¨ç½‘ç»œä¸Šâ€œæœ‰çº¿â€ä¼ è¾“é¥æµ‹æ•°æ®æ—¶æ‰€éµå¾ªçš„æ•°æ®æ ¼å¼ï¼‹ä¼ è¾“è§„èŒƒã€‚å®ƒå®šä¹‰äº†æ•°æ®åœ¨â€œçº¿ä¸Šâ€ï¼ˆon the wireï¼‰é•¿ä»€ä¹ˆæ ·å­ã€å¦‚ä½•æ‰“åŒ…ã€å¦‚ä½•åˆ†ç‰‡ã€ç”¨ä»€ä¹ˆä¼ è¾“å±‚åè®®ç­‰ã€‚
API/SDKï¼ˆå³â€œæ— ä»£ç åè®®â€æˆ–â€œå†…å­˜åè®®â€ï¼‰å…³æ³¨çš„æ˜¯ç¨‹åºå†…éƒ¨å¦‚ä½•è°ƒç”¨ Tracer.StartSpan()ã€Meter.Record()ï¼›

åŸç”Ÿ Instrumentation æ˜¯ OpenTelemetryï¼ˆOTelï¼‰ä¸ºå¸¸è§æ¡†æ¶ï¼ˆå¦‚ Springã€Ginã€Kafka ç­‰ï¼‰æä¾›çš„é¢„ç½®æ¢é’ˆã€‚å®ƒé€šè¿‡æ¡†æ¶è‡ªèº«çš„æ‰©å±•ç‚¹ï¼ˆå¦‚ Spring çš„ AOPã€Kafka çš„æ‹¦æˆªå™¨ï¼‰è‡ªåŠ¨æ³¨å…¥ç›‘æ§é€»è¾‘ï¼Œå¼€å‘è€…æ— éœ€ä¿®æ”¹ä¸šåŠ¡ä»£ç å³å¯ç”Ÿæˆ Logsã€Metricsã€Traces æ•°æ®ï¼ˆåªæ˜¯ç²—ç²’åº¦çš„ï¼Œåªæœ‰æ–¹æ³•è°ƒç”¨å’Œé”™è¯¯ç­‰è¿™äº›æœ‰ï¼‰
è‹¥æ¡†æ¶æ— åŸç”Ÿ Instrumentation çš„åº”å¯¹æ–¹æ¡ˆ
ä½¿ç”¨ç¤¾åŒºæˆ–å‚å•†æä¾›çš„æ‰©å±•åº“
æ‰‹åŠ¨åŸ‹ç‚¹ä¸ä¸­é—´ä»¶æ‹¦æˆª
ç½‘ç»œå±‚æ—è·¯ç›‘æ§